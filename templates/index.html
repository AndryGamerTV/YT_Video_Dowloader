<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TubeSaver | –ó–∞–≤–∞–Ω—Ç–∞–∂—É–≤–∞—á</title>
    
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><circle cx=%2250%22 cy=%2250%22 r=%2245%22 fill=%22%23ff0050%22/><path d=%22M35 30 L75 50 L35 70 Z%22 fill=%22white%22/></svg>">
    
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
</head>
<body>

    <div class="lang-switch">
        <select id="langSelect" onchange="changeLanguage(this.value)">
            <option value="uk">üá∫üá¶ –£–∫—Ä–∞—ó–Ω—Å—å–∫–∞</option>
            <option value="en">üá∫üá∏ English</option>
            <option value="ru">üá∑üá∫ –†—É—Å—Å–∫–∏–π</option>
            <option value="de">üá©üá™ Deutsch</option>
            <option value="pl">üáµüá± Polski</option>
        </select>
    </div>

    <div class="container">
        <header>
            <h1>Tube<span>Saver</span></h1>
            <p data-i18n="subtitle">–®–≤–∏–¥–∫–µ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –±–µ–∑ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä—ñ</p>
        </header>

        <div class="card">
            <div class="input-group">
                <input type="text" id="videoUrl" placeholder="...">
                <button onclick="analyzeVideo()" data-i18n="btn_find">–ó–Ω–∞–π—Ç–∏</button>
            </div>

            <div id="loader" class="loader hidden"></div>

            <div id="result" class="result hidden">
                <img id="thumb" src="" alt="Thumbnail">
                <div class="info">
                    <h3 id="videoTitle">Title</h3>
                    <p id="videoDuration">00:00</p>
                </div>

                <div class="settings-box">
                    
                    <div class="setting-row">
                        <label data-i18n="lbl_format">–§–æ—Ä–º–∞—Ç:</label>
                        <select id="modeSelect" onchange="toggleOptions()">
                            <option value="video" data-i18n="opt_video">–í—ñ–¥–µ–æ (MP4)</option>
                            <option value="audio" data-i18n="opt_audio">–ê—É–¥—ñ–æ (MP3)</option>
                        </select>
                    </div>

                    <div class="setting-row" id="videoOptions">
                        <label data-i18n="lbl_res">–Ø–∫—ñ—Å—Ç—å:</label>
                        <select id="resSelect">
                            </select>
                    </div>

                    <div class="setting-row hidden" id="audioOptions">
                        <label data-i18n="lbl_bitrate">–ë—ñ—Ç—Ä–µ–π—Ç:</label>
                        <select id="bitrateSelect">
                            <option value="320">320 kbps (High)</option>
                            <option value="192" selected>192 kbps (Normal)</option>
                            <option value="128">128 kbps (Low)</option>
                        </select>
                    </div>

                    <button class="download-btn" onclick="downloadContent()" data-i18n="btn_download">–ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏</button>
                </div>
            </div>
            
            <p id="statusMessage"></p>
        </div>
    </div>

    <script>
        const translations = {
            uk: {
                subtitle: "–®–≤–∏–¥–∫–µ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –±–µ–∑ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä—ñ",
                placeholder: "–í—Å—Ç–∞–≤—Ç–µ –ø–æ—Å–∏–ª–∞–Ω–Ω—è –Ω–∞ YouTube...",
                btn_find: "–ó–Ω–∞–π—Ç–∏",
                btn_download: "–ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ —Ñ–∞–π–ª",
                lbl_format: "–§–æ—Ä–º–∞—Ç:",
                lbl_res: "–Ø–∫—ñ—Å—Ç—å:",
                lbl_bitrate: "–Ø–∫—ñ—Å—Ç—å –∑–≤—É–∫—É:",
                opt_video: "–í—ñ–¥–µ–æ (MP4)",
                opt_audio: "–ê—É–¥—ñ–æ (MP3)",
                status_ready: "–ì–æ—Ç–æ–≤–æ! –§–∞–π–ª –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–æ.",
                status_downloading: "–û–±—Ä–æ–±–∫–∞...",
                status_error: "–ü–æ–º–∏–ª–∫–∞: ",
                status_conn_err: "–ü–æ–º–∏–ª–∫–∞ –∑'—î–¥–Ω–∞–Ω–Ω—è"
            },
            en: {
                subtitle: "Fast download, no server storage",
                placeholder: "Paste YouTube link here...",
                btn_find: "Find",
                btn_download: "Download File",
                lbl_format: "Format:",
                lbl_res: "Quality:",
                lbl_bitrate: "Audio Quality:",
                opt_video: "Video (MP4)",
                opt_audio: "Audio (MP3)",
                status_ready: "Done! File downloaded.",
                status_downloading: "Processing...",
                status_error: "Error: ",
                status_conn_err: "Connection Error"
            },
            ru: {
                subtitle: "–ë—ã—Å—Ç—Ä–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –±–µ–∑ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ",
                placeholder: "–í—Å—Ç–∞–≤—å—Ç–µ —Å—Å—ã–ª–∫—É –Ω–∞ YouTube...",
                btn_find: "–ù–∞–π—Ç–∏",
                btn_download: "–°–∫–∞—á–∞—Ç—å —Ñ–∞–π–ª",
                lbl_format: "–§–æ—Ä–º–∞—Ç:",
                lbl_res: "–ö–∞—á–µ—Å—Ç–≤–æ:",
                lbl_bitrate: "–ö–∞—á–µ—Å—Ç–≤–æ –∑–≤—É–∫–∞:",
                opt_video: "–í–∏–¥–µ–æ (MP4)",
                opt_audio: "–ê—É–¥–∏–æ (MP3)",
                status_ready: "–ì–æ—Ç–æ–≤–æ! –§–∞–π–ª —Å–∫–∞—á–∞–Ω.",
                status_downloading: "–û–±—Ä–∞–±–æ—Ç–∫–∞...",
                status_error: "–û—à–∏–±–∫–∞: ",
                status_conn_err: "–û—à–∏–±–∫–∞ —Å–µ—Ç–∏"
            },
            de: {
                subtitle: "Schneller Download ohne Speicherung",
                placeholder: "YouTube-Link hier einf√ºgen...",
                btn_find: "Suchen",
                btn_download: "Herunterladen",
                lbl_format: "Format:",
                lbl_res: "Qualit√§t:",
                lbl_bitrate: "Audioqualit√§t:",
                opt_video: "Video (MP4)",
                opt_audio: "Audio (MP3)",
                status_ready: "Fertig!",
                status_downloading: "Verarbeitung...",
                status_error: "Fehler: ",
                status_conn_err: "Verbindungsfehler"
            },
            pl: {
                subtitle: "Szybkie pobieranie bez zapisywania",
                placeholder: "Wklej link do YouTube tutaj...",
                btn_find: "Szukaj",
                btn_download: "Pobierz plik",
                lbl_format: "Format:",
                lbl_res: "Jako≈õƒá:",
                lbl_bitrate: "Jako≈õƒá d≈∫wiƒôku:",
                opt_video: "Wideo (MP4)",
                opt_audio: "Audio (MP3)",
                status_ready: "Gotowe!",
                status_downloading: "Przetwarzanie...",
                status_error: "B≈ÇƒÖd: ",
                status_conn_err: "B≈ÇƒÖd po≈ÇƒÖczenia"
            }
        };

        let currentLang = 'uk';

        document.addEventListener("DOMContentLoaded", () => {
            changeLanguage('uk');
        });

        function changeLanguage(lang) {
            currentLang = lang;
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                if(translations[lang][key]) el.innerText = translations[lang][key];
            });
            document.getElementById('videoUrl').placeholder = translations[lang]['placeholder'];
        }

        function toggleOptions() {
            const mode = document.getElementById('modeSelect').value;
            const vidOpts = document.getElementById('videoOptions');
            const audOpts = document.getElementById('audioOptions');

            if (mode === 'video') {
                vidOpts.classList.remove('hidden');
                audOpts.classList.add('hidden');
            } else {
                vidOpts.classList.add('hidden');
                audOpts.classList.remove('hidden');
            }
        }

        async function analyzeVideo() {
            const url = document.getElementById('videoUrl').value;
            const status = document.getElementById('statusMessage');
            const resultDiv = document.getElementById('result');
            const loader = document.getElementById('loader');
            const resSelect = document.getElementById('resSelect');

            if(!url) return;

            status.innerText = "";
            resultDiv.classList.add('hidden');
            loader.classList.remove('hidden');

            try {
                const response = await fetch('/get-video-info', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({url: url})
                });
                const data = await response.json();

                if(data.error) {
                    status.innerText = translations[currentLang].status_error + data.error;
                } else {
                    document.getElementById('thumb').src = data.thumbnail;
                    document.getElementById('videoTitle').innerText = data.title;
                    document.getElementById('videoDuration').innerText = data.duration;
                    
                    resSelect.innerHTML = ''; 
                    
                    if (data.resolutions && data.resolutions.length > 0) {
                        data.resolutions.forEach(res => {
                            const opt = document.createElement('option');
                            opt.value = res;
                            
                            let label = res + 'p';
                            if (res >= 2160) label += ' (4K Ultra HD)';
                            else if (res >= 1440) label += ' (2K QHD)';
                            else if (res >= 1080) label += ' (Full HD)';
                            else if (res >= 720) label += ' (HD)';
                            
                            opt.text = label;
                            resSelect.appendChild(opt);
                        });
                    } else {
                        const opt = document.createElement('option');
                        opt.value = 'best';
                        opt.text = 'Best Quality';
                        resSelect.appendChild(opt);
                    }

                    resultDiv.classList.remove('hidden');
                }
            } catch (e) {
                console.error(e);
                status.innerText = translations[currentLang].status_conn_err;
            } finally {
                loader.classList.add('hidden');
            }
        }

        async function downloadContent() {
            const url = document.getElementById('videoUrl').value;
            const btn = document.querySelector('.download-btn');
            const mode = document.getElementById('modeSelect').value;
            const resolution = document.getElementById('resSelect').value;
            const bitrate = document.getElementById('bitrateSelect').value;
            
            const originalText = btn.innerText;
            btn.innerText = translations[currentLang].status_downloading;
            btn.disabled = true;

            try {
                const response = await fetch('/download', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        url: url,
                        mode: mode,
                        resolution: resolution,
                        bitrate: bitrate
                    })
                });

                if (response.ok) {
                    let filename = "download.mp4";
                    const disposition = response.headers.get('Content-Disposition');
                    
                    if (disposition) {
                        const filenameStar = disposition.match(/filename\*=UTF-8''([^;]+)/);
                        if (filenameStar && filenameStar[1]) {
                            filename = decodeURIComponent(filenameStar[1]);
                        }
                    }

                    const blob = await response.blob();
                    const downloadUrl = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = downloadUrl;
                    a.download = filename;
                    document.body.appendChild(a);
                    a.click();
                    a.remove();
                    btn.innerText = translations[currentLang].status_ready;
                } else {
                    const errData = await response.json();
                    alert(errData.error || "Error");
                    btn.innerText = "Error";
                }
            } catch (e) {
                console.error(e);
                btn.innerText = translations[currentLang].status_conn_err;
            } finally {
                setTimeout(() => { btn.innerText = originalText; btn.disabled = false; }, 3000);
            }
        }
    </script>
</body>
</html>